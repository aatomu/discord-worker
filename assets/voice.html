<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>SpeechToText</title>
	<style>
		body {
			padding: 0;
			margin: 0;
			width: 100vw;
			height: 100vh;

			display: flex;
			flex-direction: column;
			flex-wrap: nowrap;
			justify-content: center;
			align-items: center;

			background-color: #222831;
		}

		.log {
			width: 70vw;
			height: 15lh;
			padding: 10px;

			border-radius: 1ch;
			border-width: 2px;
			border-style: solid;
			background-color: #31363F;

			overflow-y: scroll;
		}

		.mic_green {
			border-color: #B4E8C0
		}

		.mic_red {
			border-color: #EE9494
		}

		.log>span:not(.temporary) {
			color: #76ABAE;
		}

		.interface {
			margin: 1ch;
			padding: 1ch;
			width: 30vw;

			border-radius: 1ch;
			background-color: #EEEEEE;
		}

		.temporary {
			color: gray;
		}
	</style>
</head>

<body>
	<div id="log" class="log">
		<span id="temporary" class="temporary">...</span>
	</div>
	<div class="interface">
		<button id="enable">Enable "Speech to text"</button><br>
		<span id="stat">Status:</span><br>
	</div>
</body>

<script>
	const url = new URL(window.location.href)
	const param = new URLSearchParams(url.searchParams)
	let autoRestart = true

	// WebAudioAPI Call
	const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
	const recognition = new SpeechRecognition();
	recognition.continuous = true;
	recognition.interimResults = true
	recognition.lang = "ja-jp";

	// Event:
	// start soundstart speechstart speechend soundend end
	recognition.addEventListener("speechstart", () => {
		console.log("Event: speechstart")

		const log = document.getElementById("log")
		log.classList.add("mic_green")
		log.classList.remove("mic_red")
	})

	recognition.addEventListener("speechend", () => {
		console.log("Event: speechend")

		const log = document.getElementById("log")
		log.classList.remove("mic_green")

		if (autoRestart) {
			console.log("Restart: call")
			recognition.stop()

			setTimeout(() => {
				console.log("Restart: run")
				recognition.start()
			}, 1 * 1000)
		}
	})

	recognition.addEventListener("error", (e) => {
		console.log("Event: error", e)

		switch (e.error) {
			case "not-allowed", "service-not-allowed": {
				console.log("exit by error")
				setStat(`Error "${e.error}"`)
				autoRestart = false

				const log = document.getElementById("log")
				log.classList.add("mic_red")
				log.classList.remove("mic_green")
				return
			}
			default: {
				console.log("Error: through this error")
				recognition.dispatchEvent(new Event("speechend"));
			}
		}
	})

	recognition.addEventListener("result", (event) => {
		const temporary = document.getElementById("temporary")
		const log = document.getElementById("log")
		const index = event.results.length - 1
		const results = []
		for (let i = 0; i < event.results[index].length; i++) {
			results.push(event.results[index][i].transcript)
		}
		const text = results.join("")

		if (event.results[index].isFinal) {
			if (text == "") {
				return
			}
			const now = new Date()
			console.log(`Recognition: \"${text}\"`)
			const logLine = document.createElement("span")
			logLine.innerText = `${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}:${now.getSeconds().toString().padStart(2, "0")}.${now.getMilliseconds().toString().substring(0, 3).padEnd(3, "0")} ${text}`
			log.insertBefore(logLine, temporary)
			log.insertBefore(document.createElement("br"), temporary)

			temporary.innerText = "..."
			log.scrollTop = log.scrollHeight;

			const id = param.get("id")
			const token = param.get("token")
			if (id && token) {
				fetch(`/voice_save`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json"
					},
					body: JSON.stringify({
						id: id,
						token: token,
						text: text
					})
				})
			}

			return
		}

		console.log(`Recognition: \"${text}\"?`)
		temporary.innerText = text
	})

	document.getElementById("enable").addEventListener("click", async () => {
		setStat("Wait permission accept")
		await recognition.start()
		setStat("Speech to text Ready...")
	})

	function setStat(message) {
		const stat = document.getElementById("stat")
		stat.innerText = `Stat: ${message}`
	}
</script>

</html>
